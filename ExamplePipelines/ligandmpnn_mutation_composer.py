"""
This pipeline shows how to generate a lot of LigandMPNN sequences,
use MutationProfiler to identify which mutations have been generated across all 1000 sequences,
and use several modes of the MutationComposer to generate new sequences and fold them with Boltz2.

We also fold the first 10 sequences generated by LigandMPNN for comparison with the ones generated by MutationComposer.
"""

import os, sys
sys.path.insert(0, os.getcwd()) #to see scripts in current folder

from PipelineScripts.pipeline import *
from PipelineScripts.load_output import LoadOutput
from PipelineScripts.ligand_mpnn import LigandMPNN
from PipelineScripts.slice_table import SliceTable
from PipelineScripts.boltz2 import Boltz2
from PipelineScripts.residue_atom_distance import ResidueAtomDistance
from PipelineScripts.merge_tables import MergeTables
from PipelineScripts.mutation_profiler import MutationProfiler
from PipelineScripts.mutation_composer import MutationComposer
from PipelineScripts.filter import Filter
from PipelineScripts.concatenate_tables import ConcatenateTables
from PipelineScripts.extract_metrics import ExtractMetrics


with Pipeline(project="Examples",
              job="LigandMPNN-MutationComposer",
              description="Profiling of mutations occuring over 1000 sequences generated by LigandMPNN, with first 10 sequences folded for comparison"):

    Resources(gpu="V100",
              time="24:00:00",
              memory="16GB")


    original_open = LoadOutput('/shares/locbp.chem.uzh/public/BioPipelines/Boltz/HT7_Cy7_C_R_001/ToolOutputs/1_Boltz2_output.json')
    original_close = LoadOutput('/shares/locbp.chem.uzh/public/BioPipelines/Boltz/HT7_Cy7_C_RR_001/ToolOutputs/1_Boltz2_output.json')

    original_analysis = MergeTables(tables=[original_open.tables.affinity,
                                                    original_close.tables.affinity],
                                        prefixes=["open_","close_"],
                                        id_map={'original':["HT7_Cy7_C_R","HT7_Cy7_C_RR"]},
                                        calculate = {"affinity_delta":"open_affinity_pred_value-close_affinity_pred_value"})

    mutation_range = "141+143+145+147-149+151-152+154+157+160-161+165+167-168+170-172+175-176+178+180+245+271"
    lmpnn = LigandMPNN(structures=original_open, 
                       ligand="LIG",
                       num_sequences=1000,
                       batch_size=25,
                       redesigned=mutation_range)


    Suffix("first_10") #suffix for these tools
    first_10_sequences = SliceTable(input=lmpnn,
                                        n_rows=10)

    #Fold the first 10 sequences from LigandMPNN for comparison
    boltz_apo_first10 = Boltz2(proteins=first_10_sequences)
    boltz_holo_open_first10 = Boltz2(proteins=first_10_sequences,
                                    ligands=original_open,
                                    msas=boltz_apo_first10,
                                    affinity=True)
    boltz_holo_close_first10 = Boltz2(proteins=first_10_sequences,
                                      ligands=original_close,
                                      msas=boltz_apo_first10,
                                      affinity=True)
    open_chlorine_aspartate_distance_first10 = ResidueAtomDistance(structures=boltz_holo_open_first10,
                                                                   residue='D in IHDWG',
                                                                   atom='LIG.Cl',
                                                                   metric_name='open_chlorine_distance')
    close_chlorine_aspartate_distance_first10 = ResidueAtomDistance(structures=boltz_holo_close_first10,
                                                                    residue='D in IHDWG',
                                                                    atom='LIG.Cl',
                                                                    metric_name='close_chlorine_distance')
    analysis_first10 = MergeTables(tables=[boltz_holo_open_first10.tables.affinity,
                                                   boltz_holo_close_first10.tables.affinity,
                                                   open_chlorine_aspartate_distance_first10.tables.analysis,
                                                   close_chlorine_aspartate_distance_first10.tables.analysis],
                                        prefixes=["open_","close_","",""],
                                        calculate = {"affinity_delta":"open_affinity_pred_value-close_affinity_pred_value"} )


    Suffix("") #remove suffix
    profiler = MutationProfiler(original=original_open,
                                mutants=lmpnn)

    all_analysis=[original_analysis,analysis_first10]  # Include first 10 analysis

    for mode in ["single_point","weighted_random","hotspot_focused","top_mutations"]:
        Suffix(mode) #all folders generated from now on will have this suffix
        composer = MutationComposer(frequencies=profiler.tables.absolute_frequencies,
                                    num_sequences=10,
                                    mode=mode,
                                    prefix=mode)

        boltz_apo = Boltz2(proteins=composer)
        boltz_holo_open = Boltz2(proteins=composer,
                                 ligands=original_open,
                                 msas=boltz_apo,
                                 affinity=True)
        boltz_holo_close = Boltz2(proteins=composer,
                                  ligands=original_close,
                                  msas=boltz_apo,
                                  affinity=True)
        open_chlorine_aspartate_distance = ResidueAtomDistance(structures=boltz_holo_open,
                                                               residue='D in IHDWG',
                                                               atom='LIG.Cl',
                                                               metric_name='open_chlorine_distance')
        close_chlorine_aspartate_distance = ResidueAtomDistance(structures=boltz_holo_close,
                                                                residue='D in IHDWG',
                                                                atom='LIG.Cl',
                                                                metric_name='close_chlorine_distance')
        analysis = MergeTables(tables=[boltz_holo_open.tables.affinity,
                                               boltz_holo_close.tables.affinity,
                                               open_chlorine_aspartate_distance.tables.analysis,
                                               close_chlorine_aspartate_distance.tables.analysis],
                                    prefixes=["open_","close_","",""],
                                    calculate = {"affinity_delta":"open_affinity_pred_value-close_affinity_pred_value"} )
        filtered_analysis = Filter(data=analysis,
                                   expression="open_chlorine_distance<5.0")
        all_analysis.append(filtered_analysis)

    Suffix("ALL_ANALYSIS")
    ConcatenateTables([x.tables.merged for x in all_analysis])
    ExtractMetrics(tables=[x.tables.merged for x in all_analysis],
                   metrics=["affinity_delta",
                            "open_affinity_pred_value",
                            "close_affinity_pred_value"])
