# Runtime-Based Filter Architecture - Complete Implementation

## Summary

The filter architecture has been successfully refactored to follow the same runtime pattern as all other pipeline tools. The new implementation generates bash scripts that execute at runtime, maintaining pipeline predictability while providing sophisticated filtering capabilities.

## Key Architectural Changes

### ✅ Runtime-Based Execution Pattern

**Before (Incorrect):**
- FilterCriterion objects analyzed structures directly during pipeline compilation
- Tools tried to execute filtering logic immediately
- Violated pipeline principle that tools predict outputs but don't execute during compilation

**After (Correct):**
```
Configuration Phase (Pipeline Compilation):
    Filter tools store parameters and predict output structure
    
Execution Phase (Runtime):
    1. Generate bash script with criterion execution commands
    2. Execute individual criterion helper scripts
    3. Combine results using pipe_filter_execution.py
```

### ✅ Proper Tool vs. Criterion Separation

- **Filter Tools** (`Filter`, `StructureFilter`): Pipeline-integrated tools that inherit from `BaseConfig`
- **Filter Criteria** (`ResidueAtomDistance`, `Confidence`): Configuration objects that specify runtime execution parameters
- **Runtime Scripts** (`pipe_criterion_*.py`): Actual filtering logic executed at runtime

### ✅ Enhanced Runtime Architecture

**Configuration Generation:**
```python
criterion.to_config_dict()  # Serializes parameters for runtime
criterion.get_runtime_script_path()  # Returns helper script path
```

**Runtime Execution:**
```bash
# Generated by Filter.generate_script()
python pipe_criterion_residue_atom_distance.py --structures_dir $DIR --config criterion1.json
python pipe_criterion_confidence.py --structures_dir $DIR --config criterion2.json
python pipe_filter_execution.py --criteria_results results/ --combination AND --max_items 5
```

## Implementation Files

### Core Architecture
- `PipelineScripts/filter_criterion.py` - Abstract base for all criteria (updated for runtime)
- `PipelineScripts/structure_criterion.py` - Structure-specific base class (updated for runtime)
- `PipelineScripts/filter.py` - Base filter tool with bash script generation
- `PipelineScripts/structure_filter.py` - Structure-specialized filter tool

### Concrete Criteria
- `PipelineScripts/residue_atom_distance.py` - Distance-based filtering configuration
- `PipelineScripts/confidence.py` - Confidence/pLDDT-based filtering configuration

### Runtime Helper Scripts
- `HelpScripts/pipe_criterion_residue_atom_distance.py` - Runtime distance evaluation
- `HelpScripts/pipe_criterion_confidence.py` - Runtime confidence evaluation
- `HelpScripts/pipe_filter_execution.py` - Combines multiple criterion results

### Testing & Examples
- `structurefilter_example.py` - Updated example using runtime architecture
- `test_filter_architecture.py` - Comprehensive test suite for runtime execution

## Usage Pattern

### Basic Structure Filtering
```python
structure_filter = pipeline.add(
    StructureFilter(
        criteria=[
            ResidueAtomDistance(
                atom='ligand.Cl',
                residue='protein.D in TRGDTGH',
                expression='distance<=5'
            ),
            Confidence(
                expression='pLDDT>90',
                selection="input.datasheets.sequences.designed_residues"
            )
        ],
        input=boltz.output,
        combination="AND",
        max_items=5
    ),
    env="ProteinEnv"
)
```

### Runtime Execution Flow

1. **Pipeline Compilation**: Filter tools store criteria configurations and predict output structure
2. **Script Generation**: `generate_script()` creates comprehensive bash script
3. **Runtime Execution**: 
   - Individual criterion scripts analyze structures
   - Results are combined using specified combination method
   - Final output includes filtered structures and comprehensive metadata

### Generated Bash Script Structure
```bash
#!/bin/bash
# StructureFilter execution script

# Setup directories
mkdir -p structures_to_filter criterion_results

# Copy structures to working directory
cp input_structures/* structures_to_filter/

# Execute individual criteria
python pipe_criterion_residue_atom_distance.py --structures_dir structures_to_filter --output results1.json --config criterion1.json
python pipe_criterion_confidence.py --structures_dir structures_to_filter --output results2.json --config criterion2.json

# Combine results
python pipe_filter_execution.py --criteria '["/path/to/results1.json", "/path/to/results2.json"]' --combination AND --max-items 5

# Cleanup temporary files
```

## Key Benefits of Runtime Architecture

### 1. **Pipeline Consistency**
- Follows same pattern as ProteinMPNN, Boltz2, and other tools
- Tools predict outputs during compilation, execute via bash scripts at runtime
- No direct file system access during pipeline configuration

### 2. **Proper Library Management**
- Structure analysis libraries (BioPython, MDAnalysis) only loaded at runtime
- No import errors during pipeline configuration
- Runtime scripts check library availability and handle gracefully

### 3. **Scalable Execution**
- Individual criteria can be parallelized
- Large structure sets handled efficiently
- Memory usage optimized for runtime execution

### 4. **Enhanced Debugging**
- Individual criterion results saved as JSON for inspection
- Comprehensive logging and error reporting
- Easy to debug specific criterion failures

### 5. **Pipeline Predictability**
- Output structure known during compilation
- Filter metadata includes expected file paths
- Enhanced completion checking distinguishes critical vs content files

## Filter-Aware Pipeline Features

### Enhanced Completion Checking
```python
# Automatically detects filter outputs
# Critical files (datasheets, manifests): Must exist
# Content files (structures): Can be partially missing with warnings
```

### Metadata Integration
```python
# Filter outputs include rich metadata
if tool_output.output.is_filtered:
    print(f"Pass rate: {tool_output.output.get_filter_pass_rate():.1%}")
    print(f"Original: {tool_output.output.get_original_items_count()}")
    print(f"Kept: {tool_output.output.get_kept_items_count()}")
```

### Output Files Structure
```
FilterOutput/
├── {job_name}_filter_manifest.json     # Complete filtering metadata
├── {job_name}_filtered_structures.csv  # Datasheet with pass/fail results
├── {job_name}_filter_report.txt        # Human-readable summary
└── [filtered structure files]          # Actual kept structures
```

## Runtime Helper Script Features

### Individual Criterion Scripts
- **Library Detection**: Automatically detect and use BioPython/MDAnalysis
- **Error Handling**: Graceful failure with informative error messages
- **Result Serialization**: JSON output with scores, pass/fail status, metadata
- **Expression Evaluation**: Safe evaluation of filtering expressions

### Combined Execution Script
- **Multiple Combination Methods**: AND (intersection), OR (union), WEIGHTED (scored)
- **Max Items Filtering**: Top-N selection based on scores
- **Rich Output**: Comprehensive filtering statistics and metadata
- **File Management**: Proper cleanup and organization

## Test Results

All architecture tests pass:
- ✅ Criteria generate proper configuration for runtime execution
- ✅ Filter tools create valid bash scripts with all components
- ✅ Runtime script paths correctly specified
- ✅ Combination methods (AND, OR, WEIGHTED) working
- ✅ Pipeline integration maintained
- ✅ Filter output metadata integration
- ✅ Proper inheritance hierarchy and variable naming

## Migration from Previous Architecture

**Old Direct Execution:**
```python
# This no longer works
result = criterion.apply_to_items(structures, context)
```

**New Runtime Configuration:**
```python
# Now generates runtime configuration
config_dict = criterion.to_config_dict()
script_path = criterion.get_runtime_script_path()
```

The runtime-based filter architecture successfully addresses the fundamental architectural issue while maintaining full pipeline compatibility and providing enhanced filtering capabilities.