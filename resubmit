#!/bin/bash
# Authors (2026): G. Quargnali & P. Rivera-Fuentes @ LOCBP (https://www.locbp.com/) University of Zurich Switzerland
#
# This software is freely available for use, modification, and redistribution.

# Resubmit a SLURM job with correct output path and incremental naming
# Usage: resubmit.sh <path_to_slurm.sh>

if [ $# -eq 0 ]; then
    echo "Error: No SLURM script provided"
    echo "Usage: resubmit.sh <path_to_slurm.sh>"
    exit 1
fi

SLURM_SCRIPT="$1"

if [ ! -f "$SLURM_SCRIPT" ]; then
    echo "Error: SLURM script not found: $SLURM_SCRIPT"
    exit 1
fi

# Get the directory containing the SLURM script
SCRIPT_DIR=$(dirname "$SLURM_SCRIPT")
SCRIPT_DIR=$(cd "$SCRIPT_DIR" && pwd)  # Get absolute path

# Extract job name from SLURM script (#SBATCH --job-name=...)
JOB_NAME=$(grep "^#SBATCH.*--job-name=" "$SLURM_SCRIPT" | head -1 | sed 's/.*--job-name=\([^ ]*\).*/\1/')

# If no job name found in script, use the parent folder name
if [ -z "$JOB_NAME" ]; then
    JOB_NAME=$(basename "$(dirname "$SCRIPT_DIR")")
fi

# Find next available slurm_N.out number
N=1
while [ -f "$SCRIPT_DIR/slurm_$N.out" ]; do
    N=$((N + 1))
done

OUTPUT_FILE="$SCRIPT_DIR/slurm_$N.out"

# Submit job with output redirected to the script's directory
echo "Submitting job from: $SLURM_SCRIPT"
echo "Job name: $JOB_NAME"
echo "Output will be written to: $OUTPUT_FILE"

sbatch --job-name="$JOB_NAME" --output="$OUTPUT_FILE" "$SLURM_SCRIPT"

if [ $? -eq 0 ]; then
    echo "Job submitted successfully"
else
    echo "Error: Job submission failed"
    exit 1
fi
